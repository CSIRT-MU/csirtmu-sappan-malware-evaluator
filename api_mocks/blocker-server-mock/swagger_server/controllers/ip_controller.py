import connexion
import six
from datetime import datetime, timedelta

from swagger_server.models.ip_add_record import IPAddRecord
from swagger_server.models.ip import IP
from swagger_server.models.ip_remove_record import IPRemoveRecord
from swagger_server.models.ip_list_success_response import IPListSuccessResponse
from swagger_server.models.error_response import ErrorResponse
from swagger_server import util
from swagger_server.storage.storage_operator import StorageOperator

storage = StorageOperator()

def ip_addresses_post(body=None):  # noqa: E501
    if connexion.request.is_json:
        body = IPAddRecord.from_dict(connexion.request.get_json())
        listed = datetime.now()
        expires = None
        if (body.length):
            expires = listed + timedelta(days=body.length)
            expires = expires.strftime("%Y-%m-%dT%H:%M:%S")
        listed_str = listed.strftime("%Y-%m-%dT%H:%M:%S")
        ip = IP(ip=body.ip, reason=body.reason, who="rtbh", listed = listed_str, expires = expires)
        storage.ban_ip(ip)


def ip_addresses_put(body=None):  # noqa: E501
    """unblock ip

     # noqa: E501

    :param body: 
    :type body: dict | bytes

    :rtype: None
    """
    if connexion.request.is_json:
        body = IPRemoveRecord.from_dict(connexion.request.get_json())  # noqa: E501
        ip=IP(ip=body.ip)
        storage.unban_ip(ip)


def list_ip():  # noqa: E501
    return storage.get_ip_bans()
