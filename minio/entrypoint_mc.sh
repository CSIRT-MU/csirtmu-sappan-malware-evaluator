#!/bin/bash
tries=1
until mc alias set minio ${MINIO_HOST}:${MINIO_PORT} ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD} 2>/dev/null
do
    echo Waiting for ${MINIO_HOST}:${MINIO_PORT}. Next try in $(( 10*$tries )) seconds
    sleep $(( 10*$tries ))
    if [ $tries -eq 4 ]
    then
            echo "Tried too many times. Ending"
            exit 1
    fi
    ((tries++))
done

tries=1
until mc admin config set minio notify_webhook:malware-analysis endpoint=${CONSUMER_ENDPOINT} 2>/dev/null
do
    echo Waiting for ${CONSUMER_ENDPOINT}. Next try in $(( 10*$tries )) seconds
    sleep $(( 10*$tries ))
    if [ $tries -eq 4 ]
    then
            echo "Tried too many times. Ending"
            exit 1
    fi
    ((tries++))
done

mc admin service restart minio
mc mb minio/csirt-mu-reports --ignore-existing
mc event add minio/csirt-mu-reports arn:minio:sqs::malware-analysis:webhook --event put --ignore-existing
while : ; do sleep 1; done;