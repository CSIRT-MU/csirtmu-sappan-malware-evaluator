import logging
from datetime import datetime, timedelta

from airflow.decorators import dag, task
from airflow.operators.python import get_current_context
from airflow.operators.dummy import DummyOperator
from airflow.operators.python import BranchPythonOperator

from airflow.providers.redis.hooks.redis import RedisHook

import json


from operators.blocker.email_block_list_operator import BlockEmailListOperator

logger = logging.getLogger("airflow.task")

docs = """
## Email Blocker - block multiple emails

Input format:

```
{
    "emails": [
        {
            "email": "test@example.com",
            "reason": "example reason",
            "length": 14,
            "who": "csirt"
        }
    ],
}
```
"""
# callables


def setup_notification_services(**kwargs):
    services = {
        "redis": "push_result_to_redis"
    }
    branch_to = [services.get(key, None) for key in kwargs.keys(
    ) if key in services and kwargs[key]]
    if not branch_to:
        return 'end_without_notifying'
    return branch_to


# connections
BLOCKER_CONN_ID = 'blocker_conn_id'
REDIS_CONN_ID = 'redis_xcom_conn_id'


@dag(
    default_args={
        'owner': 'airflow',
        'depends_on_past': False,
        'retries': 0,
        'start_date': datetime.fromtimestamp(0)
    },
    doc_md=docs,
    schedule_interval=None,
)
def block_multiple_emails_dag():
    @task(multiple_outputs=True)
    def parse_params():
        dag_params = get_current_context()["dag_run"].conf
        params = {}

        params["email_list"] = dag_params.get("emails", [])
        params["redis"] = dag_params.get("redis_key", None)
        return params

    params = parse_params()

    block_emails = BlockEmailListOperator(
        task_id='block_emails',
        email_list=params["email_list"],
        conn_id=BLOCKER_CONN_ID
    )

    block_information = block_emails.output

    check_notification = BranchPythonOperator(
        task_id='setup_notification_services',
        python_callable=setup_notification_services,
        op_kwargs={"redis": params["redis"]}
    )

    no_notify = DummyOperator(
        task_id='end_without_notifying',
    )

    @task
    def push_result_to_redis(block_information, redis_key):
        hook = RedisHook(REDIS_CONN_ID)
        client = hook.get_conn()
        client.setex(redis_key, timedelta(hours=1),
                     json.dumps(block_information))
        return redis_key

    block_emails
    check_notification >> [no_notify, push_result_to_redis(
        block_emails.output, params["redis"])]


dag = block_multiple_emails_dag()
