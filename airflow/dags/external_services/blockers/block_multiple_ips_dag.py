import logging
from datetime import datetime, timedelta

from airflow.decorators import dag, task
from airflow.operators.dummy import DummyOperator
from airflow.operators.python import BranchPythonOperator
from airflow.operators.python import get_current_context

from airflow.providers.redis.hooks.redis import RedisHook

import json

from operators.blocker.ip_block_list_operator import BlockIPListOperator
logger = logging.getLogger("airflow.task")

docs = """
## IP Blocker - block multiple IPs

Input format:

```
{
    "ips": [
        {
            "ip": "example.com",
            "reason": "example reason",
            "length": 14
        }
    ],
}
```
"""
# callables


def setup_notification_services(**kwargs):
    services = {
        "redis": "push_result_to_redis"
    }
    branch_to = [services.get(key, None) for key in kwargs.keys(
    ) if key in services and kwargs[key]]
    if not branch_to:
        return 'end_without_notifying'
    return branch_to


# connections
BLOCKER_CONN_ID = 'blocker_conn_id'
WHITELIST_CONN_ID = 'whitelist_conn_id'
REDIS_CONN_ID = 'redis_xcom_conn_id'


@dag(
    default_args={
        'owner': 'airflow',
        'depends_on_past': False,
        'retries': 0,
        'start_date': datetime.fromtimestamp(0)
    },
    doc_md=docs,
    schedule_interval=None,
)
def block_multiple_ips_dag():
    @task(multiple_outputs=True)
    def parse_params():
        dag_params = get_current_context()["dag_run"].conf
        params = {}

        params["ip_list"] = dag_params.get("ips", [])
        params["redis"] = dag_params.get("redis_key", None)

        return params

    params = parse_params()

    block_ip = BlockIPListOperator(
        task_id='block_ips',
        ip_list=params["ip_list"],
        blocker_conn_id=BLOCKER_CONN_ID,
        whitelist_conn_id=WHITELIST_CONN_ID
    )

    check_notification = BranchPythonOperator(
        task_id='setup_notification_services',
        python_callable=setup_notification_services,
        op_kwargs={"redis": params["redis"]}
    )

    no_notify = DummyOperator(
        task_id='end_without_notifying',
    )

    @task
    def push_result_to_redis(block_information, redis_key):
        hook = RedisHook(REDIS_CONN_ID)
        client = hook.get_conn()
        client.setex(redis_key, timedelta(hours=1),
                     json.dumps(block_information))
        return redis_key

    block_ip
    check_notification >> [no_notify,  push_result_to_redis(
        block_ip.output, params['redis'])]


dag = block_multiple_ips_dag()
