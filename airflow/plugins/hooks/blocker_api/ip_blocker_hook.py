from airflow.hooks.base_hook import BaseHook
from blocker_api_mock_swagger_client.api.ip_api import IpApi
from blocker_api_mock_swagger_client.api_client import ApiClient
from blocker_api_mock_swagger_client.configuration import Configuration
from blocker_api_mock_swagger_client.models.ip_add_record import IPAddRecord
from urllib.parse import unquote


class IPBlockerApiHook(BaseHook):

    def __init__(self, conn_id):
        self._conn_id = conn_id
        self._connection = None

    def get_conn(self):
        """
        return connection uri to dnsrpz
        """
        if self._connection is not None:
            return self._connection
        config = Configuration()
        config.host = self.get_uri()
        config.verify_ssl = False

        apiclient = ApiClient(config)

        self._connection = IpApi(apiclient)
        return self._connection

    def get_uri(self):
        """
        return connection uri to dnsrpz
        """
        config = self.get_connection(self._conn_id)
        uri = config.get_uri()
        if (config.conn_type == 'http' and config.port == 443):
            uri = uri.replace('http://','https://')
        return unquote(uri)

    def get_ip_blacklist(self):
        """
        returns blacklist
        """
        connection = self.get_conn()
        data = connection.list_ip()
        return data

    def ban_ip(self, ip, reason="", length=0):
        """
        ban ip address
        """
        connection = self.get_conn()
        params = IPAddRecord(ip=ip, length=length, reason=reason)
        connection.ip_addresses_post(body=params)
