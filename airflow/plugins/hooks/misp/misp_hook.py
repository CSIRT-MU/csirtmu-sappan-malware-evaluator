from pymisp.api import PyMISP
from airflow.hooks.base_hook import BaseHook


class MISPHook(BaseHook):
    def __init__(self, conn_id):
        self._conn_id = conn_id
        self._client = None

    def get_uri(self, conn):
        if conn.host and "://" in conn.host:
            base_url = conn.host
        else:
            schema = conn.schema if conn.schema else "http"
            host = conn.host if conn.host else ""
            base_url = schema + "://" + host

        if conn.port:
            base_url += ":" + str(conn.port)   
        return base_url

    def get_api_key(self, conn):
        return conn.password
        
    def get_conn(self):
        """
        return misp client
        """
        if self._client is not None:
            return self._client

        conn = self.get_connection(self._conn_id)
        url = self.get_uri(conn)
        auth = self.get_api_key(conn)

        self._client = PyMISP(url = url, key = auth, ssl = "https" in url)
        return self._client