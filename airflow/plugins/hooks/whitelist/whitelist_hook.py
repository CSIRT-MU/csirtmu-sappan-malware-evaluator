from airflow.hooks.base_hook import BaseHook
from whitelist_api_mock_swagger_client.api.default_api import DefaultApi
from whitelist_api_mock_swagger_client.api_client import ApiClient
from whitelist_api_mock_swagger_client.configuration import Configuration
from urllib.parse import unquote


class WhitelistHook(BaseHook):
    def __init__(self, conn_id):
        self._conn_id = conn_id
        self._base_url = None
        self._connection = None

    def get_conn(self):
        """
        return connection uri to dnsrpz
        """
        if self._connection is not None:
            return self._connection
        uri = self.get_uri()
        config = Configuration()
        config.host = uri
        config.verify_ssl = False

        self._connection = ApiClient(config)
        return self._connection

    def get_uri(self):
        """
        return connection uri to dnsrpz
        """
        config = self.get_connection(self._conn_id)
        uri = config.get_uri()
        if (config.conn_type == 'http' and config.port == 443):
            uri = uri.replace('http://','https://')
        return unquote(uri)


    def get_whitelist(self):
        """
        Return whitelist
        """
        client = DefaultApi(self.get_conn())
        data = client.list_records()
        return data
