from csirtmu.observable_evaluator.analyser.intel_owl_report import IntelOwlReport
from csirtmu.observable_evaluator.analyser.abstract_analysers import AbstractFileAnalyser, AbstractObservableAnalyser
from csirtmu.observable_evaluator.analyser.analysis_result import ObservableAnalysis, FileAnalysis

from .reports.misp_report import MISPReport


class MISPObservableAnalyser(AbstractObservableAnalyser):

    def analyse(self, intelowl_report: IntelOwlReport[MISPReport], **kwargs) -> ObservableAnalysis:
        malicious = len(intelowl_report.report.result_search) > 0
        analysis = {
            "malicious": malicious,
            "observable": "",
            "score": 100 if malicious else 0,
        }

        if kwargs.get("raw", False):
            analysis["raw"] = intelowl_report

        if detected := kwargs.get("detected", None):
            analysis['detected'] = detected

        return ObservableAnalysis(**analysis)


class MISPFileAnalyser(AbstractFileAnalyser):
    def analyse(self, intelowl_report: IntelOwlReport[MISPReport], **kwargs) -> FileAnalysis:
        malicious = len(intelowl_report.report.result_search) > 0
        analysis = {
            "malicious": malicious,
            "filename": "",
            "score": 100 if malicious else 0,
        }

        if kwargs.get("raw", False):
            analysis["raw"] = intelowl_report

        if detected := kwargs.get("detected", None):
            analysis['detected'] = detected

        return FileAnalysis(**analysis)
