#!/bin/sh

PASSWORD='$2a$10$gFrIIpkokaotOij./IBd0Ow3DrvLqTXYE0cUpLoNlEC/lExEVwoxe'
AUTHKEY='2n3i0IoEcwg9K1sAbhaaZKQqZTaNuCfaYGoCmodG'
AUTHKEY_BCRYPT='$2a$10$iIdueUW.CbrOzGe0AbyU5uGWObKyk5jXyyFI2ftR.R4LwB0z2q5ue'
KEY_START=2n3i
KEY_END=modG
KEY_UUID='6b99f59d-96dd-46a8-9b3d-503de3ba5738'

COMMENT='Hardcoded key for testing purposes'
COMMAND_USER="INSERT INTO users(password, org_id, server_id, email, authkey, nids_sid, role_id) VALUES('$PASSWORD', 1, 0, 'admin@admin.test', '$AUTHKEY', 4000000, 1);"
COMMAND_AUTH="INSERT INTO auth_keys(uuid, authkey, authkey_start, authkey_end, created, expiration, user_id, comment) VALUES('$KEY_UUID', '$AUTHKEY_BCRYPT', '$KEY_START', '$KEY_END', UNIX_TIMESTAMP(now()), 0, 1, '$COMMENT');"

until mysql -u $MYSQL_USER -h $MYSQL_HOST -D $MYSQL_DATABASE --password=$MYSQL_PASSWORD -e "SELECT * FROM users;" >/dev/null
do
echo "WAITING FOR DB TO BE UP. WILL CHECK AGAIN IN 10 SECONDS"
sleep 10
done

output=$(mysql -u $MYSQL_USER -h $MYSQL_HOST -D $MYSQL_DATABASE --password=$MYSQL_PASSWORD -e "SELECT email FROM users WHERE email='admin@admin.test';")
if [ -z "$output" ] 
then
    echo "Inserting user and hardcoded key!"
    mysql -u $MYSQL_USER -h $MYSQL_HOST -D $MYSQL_DATABASE --password=$MYSQL_PASSWORD -e "$COMMAND_USER"
    mysql -u $MYSQL_USER -h $MYSQL_HOST -D $MYSQL_DATABASE --password=$MYSQL_PASSWORD -e "$COMMAND_AUTH"
    echo "Inserted!"
else 
    echo "User already exists, hopefully with correct key!"
    echo $output
fi
