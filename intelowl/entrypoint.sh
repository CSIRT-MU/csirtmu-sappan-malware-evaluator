#!/bin/sh

if [ $# -lt 1 ]
then
    echo "Select container usage.";
    exit 1;
fi

MODE=$1
HELP="Entrypoint for IntelOwl containers. Select one of the following options:\napp\t\truns applicationserver\ncelery-beat\truns celery beat\ncelery-worker\trunscelery-worker\n"


case $MODE in
--help | -h)
echo $HELP;
;;
app)

python3 /opt/deploy/wait-for-database.py
python3 /opt/deploy/intel_owl/manage.py makemigrations
python3 /opt/deploy/intel_owl/manage.py migrate
python3 /opt/deploy/intel_owl/manage.py createsuperuser --no-input --username $DJANGO_SUPERUSER_USERNAME --email $DJANGO_SUPERUSER_EMAIL
python3 /opt/deploy/check_user_token.py
/opt/deploy/intel_owl/docker/entrypoint_uwsgi.sh
;;
celery-beat)
python3 /opt/deploy/wait-for-database.py
/usr/local/bin/celery -A intel_owl.celery beat --uid www-data --gid www-data --pidfile= --schedule=/tmp/celerybeat-schedule
;;
celery-worker)
python3 /opt/deploy/wait-for-database.py
/usr/local/bin/celery -A intel_owl.celery worker -n worker_default --uid www-data --gid www-data --time-limit=10000 --pidfile= -Ofair -Q default
;;
*)

#Printing error message
echo "invalid option or argument $MODE\n"
echo $HELP
exit 1
;;
esac
