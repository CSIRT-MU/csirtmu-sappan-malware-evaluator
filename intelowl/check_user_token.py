#!/usr/bin/python
import psycopg2
import os
import sys
from datetime import datetime, timedelta

DBNAME = os.getenv('INTELOWL_DBNAME')
DBHOST = os.getenv('DB_HOST')
DBUSER = os.getenv('DB_USER')
DBPASS = os.getenv('DB_PASSWORD')

DBTOKEN = os.getenv('DJANGO_SUPERUSER_TOKEN')
USERNAME = os.getenv('DJANGO_SUPERUSER_USERNAME')

try:
    conn = psycopg2.connect(dbname=DBNAME, host=DBHOST, user=DBUSER, password=DBPASS)
    cursor = conn.cursor()
    # obtain super user id
    cursor.execute("SELECT id FROM auth_user WHERE username = %s;", (USERNAME,))
    user_id = cursor.fetchone()
    # check if super user has key
    cursor.execute("SELECT count(*) \
                    FROM durin_authtoken \
                    WHERE client_id = '1' and current_date < expiry and user_id = %s;",
                    (user_id,)
    )
    count = cursor.fetchone()[0]
    # no key 
    if (count == 0):
        now = datetime.now()
        cursor.execute("INSERT INTO durin_authtoken (token, created, expiry, client_id, user_id) VALUES (%s, %s, %s, 1, %s);",
        (DBTOKEN,
        now,
        now + timedelta(days = 9*365),
        user_id))
        
    conn.commit()
    cursor.close()
    conn.close()
    sys.exit(0)
except psycopg2.Error as e:
    print(e.pgerror)
    print(e.pgcode)
    print(e)
    sys.exit(2)
