import axios from 'axios';
import React, {useRef} from "react";
import GatewaySubscription from "./GatewaySubscription";
import {Box, Button, Center, FormControl, Heading, Icon, HStack} from "@chakra-ui/react";
import {AiFillFileText} from "react-icons/all";


function GatewayUpload() {
    let [uploadFile, setUploadFile] = React.useState();
    let [uploaded, setUploaded] = React.useState('');

    let inputFile = useRef(null);

    const onUploadButtonClick = () => {
        inputFile.current.click();
        console.log(uploadFile);
    }

    function handleReportClosed(){
        setUploadFile('');
        setUploaded('');
    }

    const submitForm = (event) => {
        event.preventDefault();

        const dataArray = new FormData();
        dataArray.append("uploadFile", uploadFile);

        axios
            .post(`http://${process.env.REACT_APP_GATEWAY_HOST}:${process.env.REACT_APP_GATEWAY_PORT}/gateway/minio-upload`, dataArray, {
                headers: {
                    "Content-Type": "multipart/form-data"
                }
            })
            .then((response) => {
                console.log(response.data['uploaded_files'][0].subscriptionReportName);
                setUploaded(response.data['uploaded_files'][0].subscriptionReportName);
            })
            .catch((error) => {
                if (error) console.log(error);
            });
    };

    return (
        <Box>
            <Center>
                { !uploaded ? (
                <Box w="50%" mt={5}>
                    <FormControl id="upload">
                        <input type="file" ref={inputFile}
                               onChange={(e) => setUploadFile(e.target.files[0])}
                               style={{display: 'none'}}
                        />
                        <Center>
                            <Heading>Submit file to malware analyzer</Heading>
                        </Center>
                        <Center>
                            <Box mt="25%">
                            {uploadFile ? (
                                <Box>
                                    <Box border="2px" borderRadius="lg" borderColor="gray.300" px={5} py={5}>
                                        <Heading fontSize="3xl"><Icon as={AiFillFileText}/> {uploadFile && uploadFile.name}</Heading>
                                    </Box>
                                    <Center>
                                        <HStack mt={10}>
                                            <Button size="lg" colorScheme="blue" variant="solid" onClick={submitForm}>Submit</Button>
                                            <Button size="lg" colorScheme="blue" variant="outline" onClick={onUploadButtonClick}>Choose
                                                different file...</Button>
                                        </HStack>
                                    </Center>
                                </Box>
                            ) : (
                                <Button size="lg"  colorScheme="blue" variant="solid" onClick={onUploadButtonClick}>Choose
                                    file...</Button>
                            )}
                            </Box>
                        </Center>
                    </FormControl>
                </Box>

                ) : (
                    <GatewaySubscription reportClosed={handleReportClosed} reportName={uploaded}/>
                )}
            </Center>
        </Box>
    );
}

export default GatewayUpload;
